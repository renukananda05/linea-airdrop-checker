index.html
<script>
  /**
   * Ensure the user wallet is on Linea (chainId 59144).
   * If not present, ask the wallet to add the Linea network.
   */
  
  const LINEA = {
    chainIdHex: "0xE708", // 59144 decimal -> 0xE708
    chainIdDec: 59144,
    chainName: "Linea Mainnet",
    rpcUrls: ["https://rpc.linea.build"],
    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
    blockExplorerUrls: ["https://lineascan.build"]
  };
  
  async function ensureLineaNetwork() {
    if (!window.ethereum) {
      console.error("No injected wallet found (window.ethereum). Install MetaMask.");
      return { ok: false, reason: "no_wallet" };
    }
  
    try {
      // Try to switch to Linea
      await window.ethereum.request({
        method: "wallet_switchEthereumChain",
        params: [{ chainId: LINEA.chainIdHex }]
      });
      console.log("Switched to Linea (already present).");
      return { ok: true };
    } catch (switchError) {
      // 4902 = chain not found in wallet
      const code = switchError?.code;
      console.warn("switchEthereumChain failed:", switchError);
  
      if (code === 4902) {
        // Try to add the chain
        try {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: LINEA.chainIdHex,
              chainName: LINEA.chainName,
              rpcUrls: LINEA.rpcUrls,
              nativeCurrency: LINEA.nativeCurrency,
              blockExplorerUrls: LINEA.blockExplorerUrls
            }]
          });
          console.log("Linea added to wallet and selected.");
          return { ok: true };
        } catch (addError) {
          console.error("wallet_addEthereumChain failed:", addError);
          return { ok: false, reason: "add_failed", error: addError };
        }
      } else {
        // Other switch errors (user rejected, network mismatch, etc.)
        return { ok: false, reason: "switch_failed", error: switchError };
      }
    }
  }
  
  /** Connect wallet and ensure the wallet is on Linea */
  async function connectWalletAndEnsureLinea() {
    try {
      if (!window.ethereum) {
        alert("No injected wallet found. Install MetaMask or a compatible wallet.");
        return;
      }
  
      // Ensure network first
      const res = await ensureLineaNetwork();
      if (!res.ok) {
        if (res.reason === "no_wallet") {
          alert("No wallet detected. Install MetaMask.");
        } else if (res.reason === "add_failed") {
          alert("Could not add Linea network to your wallet. Check console for details.");
        } else if (res.reason === "switch_failed") {
          // If user rejected the network switch, politely notify them
          alert("Please switch your wallet to the Linea network (59144) and then connect.");
        }
        console.error("Network ensure result:", res);
        return;
      }
  
      // Request accounts (connect)
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      const addr = accounts && accounts[0];
      console.log("Connected address:", addr);
      // Update your UI with the address
      const el = document.querySelector("#connectedAddress");
      if (el) el.textContent = addr;
  
      // Optionally get chainId and balance:
      const chainId = await window.ethereum.request({ method: "eth_chainId" });
      console.log("Current chainId:", chainId);
  
      // Try to fetch ETH balance via injected provider
      try {
        const balanceHex = await window.ethereum.request({
          method: "eth_getBalance",
          params: [addr, "latest"]
        });
        const balance = BigInt(balanceHex).toString(); // hex -> bigint string
        // Format balance in ETH (simple)
        const eth = Number(BigInt(balanceHex) / 10n ** 18n) + (Number(BigInt(balanceHex) % 10n ** 18n) / 1e18);
        console.log("Injected ETH balance:", eth);
        const balEl = document.querySelector("#injectedBalance");
        if (balEl) balEl.textContent = `${eth} ETH (injected)`;
      } catch (balErr) {
        console.warn("Failed to get injected balance:", balErr);
        const balEl = document.querySelector("#injectedBalance");
        if (balEl) balEl.textContent = "error";
      }
  
      // Listen for account or network changes and refresh UI appropriately
      window.ethereum.on && window.ethereum.on("accountsChanged", (accs) => {
        console.log("accountsChanged", accs);
        const el = document.querySelector("#connectedAddress");
        if (el) el.textContent = accs[0] || "Not connected";
      });
      window.ethereum.on && window.ethereum.on("chainChanged", (chain) => {
        console.log("chainChanged", chain);
        // You may want to reload or re-check balances
        // window.location.reload();
      });
  
    } catch (err) {
      console.error("connectWalletAndEnsureLinea error:", err);
      alert("Connection failed. See console for details.");
    }
  }
  
  /** Example: hook up to a button with id="connectBtn" */
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("connectBtn");
    if (btn) btn.addEventListener("click", connectWalletAndEnsureLinea);
  });
  </script>
  